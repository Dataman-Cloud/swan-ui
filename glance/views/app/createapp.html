<div class="page-header">
    <div>
        <h1 class="pull-left">新建应用</h1>
    </div>
</div>
<section>
    <div class="main-container new-app">
        <div class="main-container-body">
            <form class="form-horizontal" name="staticForm" data-ng-submit="deployApp()">
                <div class="form-group">
                    <label class="col-md-2 control-label"><span class="text-danger">* </span>应用名称</label>

                    <div class="col-md-5"
                         data-ng-class="{ 'has-error' : staticForm.appName.$invalid && !staticForm.appName.$pristine}">
                        <input type="text" class="form-control" name="appName" ng-model="deployinfo.appName"
                               data-required="required"
                               ng-pattern="/^(([a-z0-9]|[a-z0-9][a-z0-9\\-]*[a-z0-9])\\.)*([a-z0-9]|[a-z0-9][a-z0-9\\-]*[a-z0-9])$/"
                               data-ng-maxlength="64" samename>
                    </div>
                    <div data-ng-class="{ 'has-error' : staticForm.appName.$invalid && !staticForm.appName.$pristine}">
                        <p data-ng-show="staticForm.appName.$error.required && !staticForm.appName.$pristine"
                           class="help-block">应用名不能为空</p>

                        <p data-ng-show="staticForm.appName.$error.pattern && !staticForm.appName.$pristine"
                           class="help-block">应用名称不符合数人云规则命名规则</p>

                        <p data-ng-show="staticForm.appName.$error.samename && !staticForm.appName.$pristine"
                           class="help-block">应用名已存在</p>

                        <p data-ng-show="staticForm.appName.$error.maxlength && !staticForm.appName.$pristine"
                           class="help-block">最大长度 64 个字符</p>
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-md-2 control-label"><span class="text-danger">* </span>选择集群</label>

                    <div class="col-md-5">
                        <select class="form-control"
                                data-ng-options=" cluster.id as cluster.name disable when cluster.status != 'running' for cluster in clusters"
                                data-ng-model="clusterid" data-required="required"
                                ng-change="getNode(clusterid,'persistent')">
                            <option value="">--- 选择应用将要运行在哪个集群上 ---</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-md-2 control-label"><span class="text-danger">* </span>镜像地址</label>

                    <div class="col-md-5"
                         data-ng-class="{ 'has-error' : staticForm.imageurl.$invalid && !staticForm.imageurl.$pristine}">
                        <input type="text" class="form-control" name="imageurl" data-ng-model="deployinfo.imageURI"
                               data-required="required">
                    </div>
                    <div data-ng-class="{ 'has-error' : staticForm.imageurl.$invalid && !staticForm.imageurl.$pristine}">
                        <p data-ng-show="staticForm.imageurl.$error.required && !staticForm.imageurl.$pristine"
                           class="help-block">镜像地址不能为空</p>
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-md-2 control-label"><span class="text-danger">* </span>镜像版本</label>

                    <div class="col-md-5">
                        <input type="text" class="form-control" data-ng-model="imageversion" data-required="required" placeholder="版本号">
                        <span class="help-block">注:尽量不要使用 latest 作为版本号</span>
                    </div>

                </div>

                <div class="form-group">
                    <label class="col-md-2 control-label"><span class="text-danger">* </span>应用类型</label>

                    <div class="col-md-5">
                        <label class="checkbox-inline">
                            <input type="radio" ng-model="radio" value="1" data-required="required">
                            无状态应用
                        </label>
                        <label class="checkbox-inline">
                            <input type="radio" ng-model="radio" value="2" data-required="required">
                            有状态应用
                        </label>
                    </div>
                </div>

                <div class="form-group" ng-show="radio === '2'">
                    <label class="col-md-2 control-label"><span class="text-danger">* </span>选择主机</label>

                    <div class="col-md-5">
                        <select class="form-control"
                                data-ng-options=" nodeOk as nodeOk.name for nodeOk in nodesOk"
                                data-ng-model="nodeInfo" ng-change="getNodeOkIp(nodeInfo)"
                                ng-required="radio === '2'"></select>
                    </div>
                </div>

                <div class="form-group" ng-show="radio === '2'">
                    <label class="col-md-2 control-label"><span class="text-danger">* </span>主机目录</label>

                    <div class="col-md-5"
                         data-ng-class="{ 'has-error' : staticForm.dateDir.$invalid && !staticForm.dateDir.$pristine}">
                        <input type="text" name="dateDir" class="form-control" placeholder="宿主机路径"
                               data-ng-model="dateDir" ng-required="radio === '2'">
                    </div>

                    <div data-ng-class="{ 'has-error' : staticForm.dateDir.$invalid && !staticForm.dateDir.$pristine}">
                        <p data-ng-show="staticForm.dateDir.$error.required && !staticForm.dateDir.$pristine"
                           class="help-block">数据目录必须有数据</p>
                    </div>
                </div>

                <div class="form-group" ng-show="radio === '2'">
                    <label class="col-md-2 control-label"><span class="text-danger">* </span>容器目录</label>

                    <div class="col-md-5"
                         data-ng-class="{ 'has-error' : staticForm.containerDir.$invalid && !staticForm.containerDir.$pristine}">
                        <input type="text" name="containerDir" class="form-control" placeholder="容器内部目录"
                               data-ng-model="containerDir" ng-required="radio === '2'">
                    </div>

                    <div data-ng-class="{ 'has-error' : staticForm.containerDir.$invalid && !staticForm.containerDir.$pristine}">
                        <p data-ng-show="staticForm.containerDir.$error.required  && !staticForm.containerDir.$pristine"
                           class="help-block">容器目录必须有数据</p>
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-md-2 control-label"><span class="text-danger">* </span>容器规格</label>

                    <div class="col-md-2">
                        <slider ng-model="cpuSize" slider-tooltip="shows" handle="{/ cpuOptions.handle /}"
                                min="cpuOptions.min" step="cpuOptions.step" max="cpuOptions.max"></slider>
                        <p>CPU : 1.0 现为:{/cpuSize/}</p>
                    </div>


                    <div class="col-md-2">
                        <slider ng-model="memSize" slider-tooltip="shows" scale="logarithmic"
                                handle="{/ memOptions.handle /}" min="memOptions.min" step="memOptions.step"
                                max="memOptions.max"></slider>
                        <p>内存最大值: 4096MB 现为:{/memSize/}MB</p>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-md-2 control-label"><span class="text-danger">* </span>容器个数</label>

                    <div class="col-md-2"
                         data-ng-class="{ 'has-error' : staticForm.containerNum.$invalid && !staticForm.containerNum.$pristine }">
                        <input type="number" class="form-control" name="containerNum" data-ng-model="containerNum"
                               min="1" data-required="required">
                    </div>
                    <div data-ng-class="{ 'has-error' : staticForm.containerNum.$invalid && !staticForm.containerNum.$pristine }">
                        <p data-ng-show="staticForm.containerNum.$error.min && !staticForm.containerNum.$pristine"
                           class="help-block">容器个数必须大于 1 </p>

                        <p data-ng-show="staticForm.containerNum.$error.required && !staticForm.containerNum.$pristine"
                           class="help-block">容器个数不能为空 </p>
                    </div>
                </div>

                <a role="button" data-toggle="collapse" href="#collapseExample" aria-expanded="false"
                   aria-controls="collapseExample" class="col-md-offset-2 ad-set">高级设置 <span class="caret"></span></a>

                <div class="collapse" id="collapseExample">
                    <div class="well">
                        <div class="item-header">
                            <h4>应用地址</h4>
                        </div>
                        <div class="form-inline">
                            <div class="form-group"
                                 data-ng-class="{ 'has-error' : staticForm.curPort.$invalid && !staticForm.curPort.$pristine }">
                                <label>应用端口</label>
                                <input type="number" name="curPort" class="form-control" min="1" max="65535"
                                       data-ng-model="portInfo.appPort">
                            </div>
                            <div class="form-group">
                                <label>协议</label>
                                <select class="form-control" data-ng-model="portInfo.protocol">
                                    <option value="">选择协议</option>
                                    <option value="1"> TCP </option>
                                    <option value="2"> HTTP </option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>类型</label>
                                <select class="form-control" data-ng-model="portInfo.type" ng-change="changeType(portInfo.type)">
                                    <option value="">选择类型</option>
                                    <option value="1"> 对内 </option>
                                    <option value="2"> 对外 </option>
                                </select>
                            </div>

                            <div class="form-group" data-ng-show="portInfo.type === '1'">
                                <div class="form-group">
                                    <label>代理节点</label>
                                    <p ng-repeat="proxyNode in proxyNodes">{/proxyNode.ip/}</p>
                                </div>

                                <div class="form-group">
                                    <label>映射端口</label>
                                    <input type="number" class="form-control" min="1" max="65535"
                                           data-ng-model="portInfo.mapPort">
                                </div>
                            </div>

                            <div class="form-group" data-ng-show="portInfo.type === '2'">
                                <label class="checkbox-inline">
                                    <input type="radio" ng-model="portInfo.isUri" value="1" ng-change="isURI(portInfo.isUri)">
                                    有域名
                                </label>
                                <label class="checkbox-inline">
                                    <input type="radio" ng-model="portInfo.isUri" value="2" ng-change="isURI(portInfo.isUri)">
                                    无域名
                                </label>
                            </div>

                            <div class="form-group" data-ng-show="portInfo.type === '2' && portInfo.isUri === '1'">
                                <div class="form-group">
                                    <label>域名</label>
                                    <input type="text" class="form-control"
                                           data-ng-model="portInfo.uri">
                                </div>

                                <div class="form-group">
                                    <label>映射端口</label>
                                    <input type="number" class="form-control" ng-disabled="true"
                                           data-ng-model="portInfo.mapPort">
                                </div>
                            </div>

                            <div class="form-group" data-ng-show="portInfo.type === '2' && portInfo.isUri === '2'">
                                <div class="form-group">
                                    <label>网关节点</label>
                                    <p ng-repeat="gateWay in gateWays">{/gateWay.ip/}"</p>
                                </div>

                                <div class="form-group">
                                    <label>映射端口</label>
                                    <input type="number" class="form-control"
                                           data-ng-model="portInfo.mapPort">
                                </div>
                            </div>

                            <button class="btn btn-default" type="button"
                                    data-ng-disabled="!portInfo.appPort || !portInfo.protocol || !portInfo.type || portInfo.protocol === '' || portInfo.type === '' || isDisable(portInfo)"
                                    ng-click="addPortInfo(portInfo)">增加
                            </button>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-striped table-bordered" data-ng-show="portInfos.length">
                                <thead>
                                <tr>
                                    <th>应用端口</th>
                                    <th>类型</th>
                                    <th>协议</th>
                                    <th>地址</th>
                                    <th>操作</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr ng-repeat="info in portInfos">
                                    <td>{/info.appPort/}</td>
                                    <td>{/portType[info.type]/}</td>
                                    <td>{/protocolType[info.protocol]/}</td>
                                    <td>
                                        <span ng-show="info.type === '1'" ng-repeat="proxyNode in proxyNodes">{/protocolType[info.protocol]/}://{/proxyNode.ip/}:{/info.mapPort/}</span>
                                        <span ng-show="info.type === '2' && info.isUri === '2'" ng-repeat="gateWay in gateWays">{/protocolType[info.protocol]/}://{/gateWay.ip/}:{/info.mapPort/}</span>
                                        <span ng-show="info.type === '2' && info.isUri === '1'">{/protocolType[info.protocol]/}://{/info.uri/}:{/info.mapPort/}</span>
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-default btn-xs"
                                                data-ng-click="deletCurPort($index)">删除
                                        </button>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="item-header">
                            <h4>环境变量
                                <small>自定义环境变量</small>
                            </h4>
                        </div>

                        <div class="form-inline">
                            <div class="form-group">
                                <label>KEY</label>
                                <input type="text" class="form-control" placeholder="Path" data-ng-model="pathInfo.key">
                            </div>
                            <div class="form-group">
                                <label>VALUE</label>
                                <input type="text" class="form-control" data-ng-model="pathInfo.value">
                            </div>
                            <button type="button" class="btn btn-default"
                                    data-ng-disabled="!pathInfo.key || !pathInfo.key || pathInfo.key === '' || pathInfo.value === '' "
                                    data-ng-click="addPathInfo(pathInfo)">
                                增加
                            </button>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-striped table-bordered" data-ng-show="pathsInfo.length">
                                <thead>
                                <tr>
                                    <th>Key</th>
                                    <th>Value</th>
                                    <th>操作</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr data-ng-repeat="info in pathsInfo">
                                    <td>{/info.key/}</td>
                                    <td>{/info.value/}</td>
                                    <td>
                                        <button type="button" data-ng-click="deletCurPath($index)" class="btn btn-default btn-xs">删除</button>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="item-header">
                            <h4>启动命令 <small>即 CMD</small></h4>
                        </div>
                        <div class="form-inline">
                            <div class="form-group">
                                <label>启动命令</label>
                                <input type="text" class="form-control" data-ng-model="cmdInput" placeholder="输入需要运行的命令">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <div class="col-md-offset-2 col-md-3">
                        <button type="submit" class="btn btn-primary btn-block" data-ng-disabled="staticForm.$invalid"> 创 建
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</section>
